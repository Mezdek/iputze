// ---------- Prisma setup ----------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // Use "sqlite" for local dev, "postgresql" for production
  url      = env("DATABASE_URL")
}

// ---------- Enums ----------
enum RoleLevel {
  ADMIN
  MANAGER
  CLEANER
  PENDING
}

enum RoleStatus {
  ACTIVE
  DISABLED
}

enum RoomOccupancy {
  VACANT
  OCCUPIED
  UNAVAILABLE
}

enum RoomCleanliness {
  CLEAN
  DIRTY
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

// ---------- Domain models ----------

model Hotel {
  id          String    @id @default(uuid())
  name        String    @unique
  address     String?
  phone       String?
  email       String?
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  //Relations
  rooms Room[]
  roles Role[]
}

model Room {
  id          String          @id @default(uuid())
  number      String
  occupancy   RoomOccupancy   @default(VACANT)
  cleanliness RoomCleanliness @default(CLEAN)
  notes       String?
  type        String?
  capacity    Int?
  floor       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  //Relations
  hotelId         String
  hotel           Hotel             @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  tasks           Task[]
  defaultCleaners DefaultCleaners[]

  @@unique([hotelId, number])
  @@index([hotelId, occupancy])
  @@index([hotelId, cleanliness])
}

model User {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  passwordHash String
  avatarUrl    String?
  bio          String?
  timezone     String    @default("UTC")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  // Relations
  roles           Role[]
  notes           Note[]
  sessions        Session[]
  images          Image[]
  deletedImages   Image[]           @relation("ImageDeletor")
  createdTasks    Task[]            @relation("Creator")
  deletedTasks    Task[]            @relation("TaskDeletor")
  cleaners        Cleaner[]
  defaultCleaners DefaultCleaners[]
}

model Role {
  id        String     @id @default(uuid())
  level     RoleLevel  @default(PENDING)
  status    RoleStatus @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?

  //Relations
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  @@unique([userId, hotelId])
  @@index([hotelId, level, status])
  @@index([userId, status])
}

model Task {
  id               String       @id @default(uuid())
  status           TaskStatus   @default(PENDING)
  priority         TaskPriority @default(LOW)
  cancellationNote String?
  createdAt        DateTime     @default(now())
  dueAt            DateTime
  startedAt        DateTime?
  completedAt      DateTime?
  cancelledAt      DateTime?
  deletedAt        DateTime?

  //Relations
  creatorId String?
  creator   User?     @relation("Creator", fields: [creatorId], references: [id], onDelete: SetNull)
  deletorId String?
  deletor   User?     @relation("TaskDeletor", fields: [deletorId], references: [id], onDelete: SetNull)
  roomId    String
  room      Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  notes     Note[]
  images    Image[]
  cleaners  Cleaner[]

  @@index([roomId, status])
  @@index([status, priority, dueAt])
  @@index([dueAt])
  @@index([creatorId])
  @@index([status, dueAt])
  @@index([roomId, status, dueAt])
}

model Cleaner {
  taskId     String
  userId     String
  assignedAt DateTime @default(now())

  //Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([taskId, userId])
  @@index([userId, assignedAt])
}

model DefaultCleaners {
  roomId     String
  userId     String
  assignedAt DateTime @default(now())

  //Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([roomId, userId])
  @@index([userId])
}

model Note {
  id        String    @id @default(uuid())
  content   String
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  //Relations
  taskId   String
  task     Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model Image {
  id         String    @id @default(uuid())
  url        String // Cloudinary/S3 URL
  uploadedAt DateTime  @default(now())
  deletedAt  DateTime?
  exif       Json?

  //Relations
  taskId     String
  task       Task    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploaderId String
  uploader   User    @relation(fields: [uploaderId], references: [id])
  deletedBy  String?
  deletor    User?   @relation("ImageDeletor", fields: [deletedBy], references: [id])
}

// ---------- Auth models ----------

model Session {
  id             String    @id @default(uuid())
  createdAt      DateTime  @default(now())
  expiresAt      DateTime
  revokedAt      DateTime?
  ipAddress      String?
  userAgent      String?
  lastActivityAt DateTime  @default(now())
  deviceInfo     String?

  //Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
  @@index([expiresAt])
}
